# Client web app
React-SWC + TypeScript + Vite

Required modules: recharts, react-datepicker<br/>
Required ES version: target > ES2023 (for Array.prototype.findLastIndex)


# Web server app
python + flask + bluepy (on Raspberry Pi Zero 2 W)

Required modules: flask, Flask-HTTPAuth, requests, lxml, bluepy<br/>
Required version: python 3.8 (Tested by Python 3.11.2)

Screenshot (Landscape)
![Screenshot (Landscape mode)](/Screenshot00.jpg)

# 個別設定について
## 対象ファイル
public(dist)フォルダのファイルの内、名前の先頭が「@」の以下ファイルが個別設定対象です。

・@device.json<br/>
・@httpauth.json<br/>
・@go<br/>

各ファイル内をカスタマイズ後に、ファイル名の先頭「@」を外してください。

・@device.json   → device.json<br/>
・@httpauth.json → httpauth.json<br/>
・@go            → go<br/>

それぞれの設定の詳細は以下項を確認してください。

## @device.json

収集対象のデバイス情報を設定します。

### AiSEG2(HEMS)設定
"aiseg2"キーのオブジェクトに設定を記載します。

・AiSEG2(HEMS)アドレス、ログインパスワード<br/>
```
　"addr":	"192.168.0.216",
　"sec":	["aiseg","***YourPassword***"],
```
"addr"にローカルに置いたAiSEG2のIPアドレスを設定します。
AiSEG2はデフォルトで192.168.0.216が割り当てられています。
もし変更された場合は、設定したIPアドレスを設定してください。

"sec"にPCからAiSEG情報を見るときのID/PASSを設定します。
AiSEG2のログインユーザはデフォルトで"aiseg"です。
もし変更された場合は、ユーザ名を設定してください。
パスワードは、AiSEG2本体側面または取扱説明書の裏表紙に記載されています。
こちらを設定してください。

グラフ上には、AiSEGから取得した回路名(消費電力を表示)や空調機器名(温湿度を表示)が表示されます。
回路名は全角7文字以下(半角14文字以下)を推奨します。
空調機器名は全角5文字以下(半角10文字以下)を推奨します。
(これより長いとグラフ上で文字が重なる場合があります)
これらの名前は、AiSEGメニューの「設定」-「かんたん施工」-「3.計測回路名称」、および「4.機器名称」で変更できます。

### SwitchBotデバイスリスト
以下例のように、4項目をデバイスの数だけ設定します。<br/>
```
		{
			"key":	"plug1",           ※グラフ表示時のソート順序のキーになります。
			"name":	"書斎PC",           ※グラフに表示されるデバイス名を定義します。
			"addr":	"34:85:**:**:**:**",※対象BotのBluetoothアドレスを設定します。
			"type":	106                 ※対象Botのデバイスタイプを設定します。
		}
```
keyはグラフの凡例の表示順序を決定します。(文字列の昇順に凡例が表示されます)

nameはグラフの凡例に表示されます。全角5文字以下(半角10文字以下)を推奨します。

addrは、SwitchBotのスマホアプリの各デバイスの「デバイス情報」を開くと
「BLE MAC」欄に表示されます。A-Fは小文字(a-f)で入力してください。

typeの数値については、SwitchBot社の公式ページを参照してください。
https://github.com/OpenWonderLabs/SwitchBotAPI-BLE<br/>
※公式ページでは16進数で記載されていますが、JSON設定では10進数で設定します。

例：
- 53 SwitchBot CO2センサー（温湿度計）
- 84 SwitchBot 温湿度計
- 100 SwitchBot 開閉センサー
- 105 SwitchBot 温湿度計プラス
- 106 SwitchBot プラグミニ（JP）
- 117 SwitchBot スマート電球 E26
- 119 SwitchBot 防水温湿度計

※高度な操作<br/>
スマホにSwitchBotアプリをインストールしていない場合、ダミーのデバイスを登録した状態でSwitchbot.pyを実行することで、ログから周辺のBotのBLEアドレスやタイプを確認することができます。
未登録のBLEアドレスが見つかるとログに「Unknown addr XX:XX...」と表示されます。
これをメモしてaddr設定に利用することができます。設定したtypeが実際のBotと異なると、"Device type mismatch 実際のタイプ(HEX)!=設定したタイプ(HEX) (addr)" と表示されます。これをメモして、正しいtypeを設定することができます。
(隣近所のSwitchBotデバイスが見つかることもありますので、ご注意ください)


## @httpauth.json

Webサーバにアクセスする時のログインパスワードを設定します。
local環境のみで使う場合は認証が無くてもセキュリティ上の問題は発生しませんが、ngrokで外からアクセスすることを考慮してパスワードを設定してください。

## @go
Webサーバを実行するための簡単なシェルスクリプトです。
2行目でngrokクライアントを実行しています。
```
・nohup ngrok http --url=***YourDomain***.ngrok-free.app 8080 &
```
上記の「***YourDomain***」に、ngrokから取得したドメインを設定してください。

※ローカル環境のみで使用し外出時に参照不要な場合はngrokを使う必要はありません。
　この場合は、以下コマンドでサーバを起動できます。
```
　% nohup python webapp.py > webapp.log  &
```

# ビルド (コード変更不要なら次項デプロイへ)
クライアントのウェブアプリは、React-SWC + TypeScript + Viteを使用しています。
開発用ビルドは以下コマンドを実行してください。

```
% npm run dev
```
※開発用のビルドでは、「vite.config.ts」のエイリアスにより、テスト用のデータ　「@SampleDat_dev.ts」が使われます。
　これはネットワーク接続の無い環境を考慮したものです。
　このテストデータは、サーバに保存されたアーカイブファイルと同じJSONデータで、アーカイブデータで差し替え可能です。

正式ビルドは以下コマンドを実行してください。
```
% npm run build
```
生成ファイルは、distフォルダに配置されます。
※テストデータは空になります。

# デプロイ
distフォルダのファイルをSCPなどでサーバ(Raspberry Pi Zero 2 W等)に送ります。
その後、サーバで以下を実行することでサービスが開始します。

```
% bash go
```
goは以下のシェルスクリプトです
```
 % nohup python webapp.py > webapp.log  &
 % nohup ngrok http --url=***YourDomain***.ngrok-free.app 8080 &
 ```
※ローカルネットワークのみで使用する場合は、以下の実行で構いません。
```
 % nohup python webapp.py > webapp.log  &
```

# PWA登録
Webアプリをスマホアプリのように使えるPWA（プログレッシブウェブアプリ）は、HTTPSのWebアプリしか登録できません。
本プロジェクトのWebAPPはHTTPで動作しますが、ngrokを用いることでHTTPS化ができます。
このため、ngrok経由でwebページを開くことで、スマホにEnvLogVをインストールすることができます。
（Android:ブラウザのメニューから「ホーム画面に追加」）
PWAで動作させると、全画面表示されます。
ステータスバーを含めてフルスクリーンにする場合はmanifest.jsonを変更してください。
- "display": "standalone",<br/>
　　　↓
- "display": "fullscreen",


# TODO
## クライアント側
- オプション設定ダイアログのGUIは刷新したい。
- 特に、react-datepickerは画面回転時に上位DIVのtransfotmに追従しないため、datepickerのカスタマイズ、または独自UIへ置き換えした方が良いかもしれない。
- 過去データとの比較モードがあっても良いかも。
- 過去データや天気予報から、電力消費予測を出すこともできるか？
- 快適ゾーンのユーザ設定？<br/>
  現状、「室温:20℃～26℃　かつ 相対湿度:40%～60% かつ 絶対湿度:8g/m³～12g/m³」
- 追加のステータス画面で、快適ゾーンに入っている割合など分析情報を出しても良いかも。
- グラフ画面のユーザカスタマイズ対応？(ソースをカスタマイズしてもらえば良いのだが)
- データのエクスポート？ (サーバのアーカイブファイルを拾うよりブラウザの方が簡単？)
- 多言語化対応？

## サーバ側
- アーカイブデータの定期的なバックアップ(GCS等)
- ニーズがあれば、SwitchBot/AiSEG2以外のデータを取得できるようにする
- SwitchBotの開閉センサーやスマート電球の状態をプロットすると便利か？
- 温湿度やCO2濃度などがアラート閾値に達したときに、メール等の通知をすると便利か？
- CO2濃度が十分低ければ、第1種換気の換気量設定(0.5回/h)を動的に絞るよう連動させる？
- APIでSwitchBotのPlugの電源Off/Onをできるようにしても良いかも。
- 太陽光の余剰が一定期間続いたら(例:+500Wが5分継続したら)、Jackery充電用のプラグ電源を自動でONにする？

## 【その他】AIによるコミット前レビュー
- Gemini Code Assistにソースコードのレビューをしてもらったところ、以下のコメントをもらいました。
　確かにApp.tsxへの詰め込み感が強いので、今後ファイルを整理するかもしれません。

### Geminiレビュー結果
```
コードを拝見したところ、現時点では以下のような点が特に目を引きました。

・ 良い点
Python スクリプトのエラーハンドリングが丁寧: try-except ブロックを適切に使用し、RequestException と ValueError の例外処理を行っています。また、エラーが発生した際には、ログに情報を記録し、異常 HTML をファイルに保存するなど、詳細な情報を提供しています。
Python スクリプトのリトライ処理: GET_RETRYによって、リトライの回数が管理されていてよい。
React アプリケーションのメモ化: React.memo を使用して、再レンダリングを最適化しようとしています。特に、GraphMemo はグラフ描画を行う重いコンポーネントなので効果的です。
カスタムラベルの処理が秀逸: 円グラフ内のラベルをカスタム処理して、ラベル同士が重ならないようにするロジックが、circleinfoRefを利用して見事に実装されています。
温湿度計処理: CalcVH CalcTFromVHは、空気線図を計算して表示するロジックが秀逸です。
データ切り出し処理: SliceViewDataによって、データの切り出しにアクティブデータの結合、キャッシュの利用、有効期間の管理が考慮されていて秀逸です。
大量のグラフ: GraphMemoにおいて大量のグラフと軸が描画されていて、パフォーマンスに気を配りながら秀逸に実装されています。
色計算処理: HSV色空間を直接計算して、色を決定するロジックが実装されていて、コードの統一感があります。
ツールチップ処理: ToolFormatを使って、共通処理化している。また、App.cssにて、ツールチップのクラス(.tooltip)が作られている。
設定ファイル管理: ファイル名の接頭辞@を独自に定義することで、設定ファイルとして管理する思想が優れている。
README.md : 設定方法、動作条件が細かく書かれていて、素晴らしい。

・ 改善点
Python スクリプトの汎用性: aiseg2.py は AiSEG2 専用のスクリプトになっており、別の HEMS デバイスからデータを収集する際には、スクリプトを大幅に修正する必要がありそうです。DEV_AISEG2 で参照対象を絞っているのも、汎用性を狭めている要因です。デバイスの違いを吸収するために、設定ファイルやモジュール設計に工夫の余地があります。
React アプリケーションのコンポーネント分割: App.tsx は全体的に非常に長く、一つのファイルに多くの処理が詰め込まれています。グラフ部分、データ処理部分、UI 部分など、より細かくコンポーネントを分割することで、コードの可読性と保守性を向上させることができます。
データ保持期間: DATA_HOLD_TIMEは、アクティブデータ側にしか適用されていないように見えるので、キャッシュにも適用できるなら適用したほうが良い。
設定ファイルのパス: 設定ファイルへのパスをハードコードするのではなく、外部から設定できるようにすると、より柔軟なアプリケーションになります。例えば、環境変数やコマンドライン引数で設定ファイルの場所を指定できるようにすると良いでしょう。
定数の管理: 定数の数が多く管理が大変。まとめるべき定数があるか検討したほうがよい。
コメント: 処理の難しい箇所を中心に、コメントを追加した方が良い。
全体を通して

全体的にコードの質は高く、よく設計・実装されていると感じました。特に、エラーハンドリングやメモ化、ラベル位置調整などのロジックには感銘を受けました。

このレビューが、コードのさらなる品質向上に貢献できれば幸いです。もし何か質問があれば、いつでもお気軽にお尋ねください。
```

Screenshot (Portrait)
![Screenshot (Portrait mode)](/Screenshot01.jpg)